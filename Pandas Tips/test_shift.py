
# Conditional merge? or use DateFrame shift()

header = DataFrame([[1, '1986-06-30', 100],
					[1, '1986-08-29', 120],
					[1, '1986-09-30', 115],
					[1, '1986-10-31', 110],
					[1, '1986-11-28', 125],
					[1, '1986-12-31', 137],
					[2, '1986-06-30', 130],
					[2, '1986-07-31', 204],
					[2, '1986-08-29', 192],
					[2, '1986-09-30', 180],
					[2, '1986-10-31', 200],
					[2, '1986-11-28', 205],
					[2, '1986-12-31', 205]], columns=['fundno', 'caldt', 'foo'])
    
ret_mf = DataFrame([[1, '1986-06-30', 0.05],
					[1, '1986-08-29', 0.01],
					[1, '1986-09-30', -0.01],
					[1, '1986-10-31', 0.10],
					[1, '1986-11-28', 0.04],
					[1, '1986-12-31', -0.02],
					[2, '1986-06-30', -0.06],
					[2, '1986-07-31', -0.04],
					[2, '1986-08-29', 0.07],
					[2, '1986-09-30', 0.00],
					[2, '1986-10-31', -0.05],
					[2, '1986-11-28', 0.09],
					[2, '1986-12-31', 0.04]], columns=['fundno', 'caldt', 'mret'])

mf = header.merge(ret_mf,how='left',on=['fundno','caldt'])

for lag in range(1,4):
    good = mf['fundno'] == mf['fundno'].shift(lag)
    mf['ret' + str(lag)] = mf['mret'].shift(lag).where(good)
print mf